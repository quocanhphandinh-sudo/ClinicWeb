<!DOCTYPE html>
<html lang="vi">
  <head>
  <meta charset="UTF-8">
  <title>Qu·∫£n l√Ω b·ªánh nh√¢n</title>
  <style>
    /* CSS d·∫°ng c√¢y th∆∞ m·ª•c */
    .tree ul {
      list-style-type: none;
      margin-left: 20px;
      padding-left: 10px;
      border-left: 1px dashed #999;
    }
    .tree li {
      cursor: pointer;
      margin: 4px 0;
    }
    .tree li:hover {
      color: darkblue;
      font-weight: bold;
    }
    .empty {
      color: gray;
      font-style: italic;
    }
    .active-visit {
  background: #cce5ff;
  font-weight: bold;
  color: #004085;
  border-radius: 4px;
}
  </style>
</head>
<head>
  <meta charset="UTF-8">
  <title>Clinic DB Viewer</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/sql.js/1.6.2/sql-wasm.js"></script>
  <style>
    body { margin:0; font-family: Arial, sans-serif; display:flex; height:100vh; }
    #sidebar {
      width: 300px; background:#f4f4f4; border-right:1px solid #ccc; padding:10px; overflow-y:auto;
    }
    #main {
      flex:1; padding:20px; overflow-y:auto;
    }
    .patient { cursor:pointer; padding:5px; font-weight:bold; }
    .patient:hover { background:#ddd; }
    .visits { margin-left:15px; }
    .visit { cursor:pointer; padding:3px; }
    .visit:hover { background:#eee; }
    #searchBox { width:100%; padding:5px; margin-bottom:10px; }
    table { border-collapse:collapse; width:100%; margin-top:10px; }
    th, td { border:1px solid #ccc; padding:5px; text-align:left; }
    th { background:#eee; }
  </style>
</head>
<body>
  <div id="sidebar">
    <input type="file" id="dbfile" />
    <input type="text" id="searchBox" placeholder="T√¨m b·ªánh nh√¢n...">
    <div id="patientsList"></div>
  </div>
  <div id="main">
    <h2>Chi ti·∫øt kh√°m b·ªánh</h2>
    <div id="visitDetail">Ch·ªçn b·ªánh nh√¢n v√† l·∫ßn kh√°m ƒë·ªÉ xem chi ti·∫øt.</div>
  </div>

  <script>
    let db = null;

    // Load file SQLite
    document.getElementById("dbfile").addEventListener("change", async (event) => {
      const file = event.target.files[0];
      if (file) {
        const data = new Uint8Array(await file.arrayBuffer());
        const SQL = await initSqlJs({ locateFile: f => `https://cdnjs.cloudflare.com/ajax/libs/sql.js/1.6.2/${f}` });
        db = new SQL.Database(data);
        renderPatients();
      }
    });

    // Render danh s√°ch b·ªánh nh√¢n
    function renderPatients(filter="") {
      if (!db) return;
      const query = `
        SELECT PatientId, FullName, Phone
        FROM Patients
        WHERE FullName LIKE '%${filter}%' OR Phone LIKE '%${filter}%'
        ORDER BY FullName;
      `;
      let res = db.exec(query);
      if (res.length === 0) {
        document.getElementById("patientsList").innerHTML = "<p>Kh√¥ng c√≥ b·ªánh nh√¢n</p>";
        return;
      }
      let html = "";
      res[0].values.forEach(row => {
        const pid = row[0];
        const name = row[1];
        const phone = row[2] || "";
        html += `<div class="patient" onclick="toggleVisits(${pid}, this)">${name} (${phone})</div>
                 <div id="visits-${pid}" class="visits"></div>`;
      });
      document.getElementById("patientsList").innerHTML = html;
    }

    function toggleVisits(patientId, el) {
      const container = document.getElementById("visits-" + patientId);
      if (container.innerHTML.trim() !== "") {
        container.innerHTML = ""; // collapse
        return;
      }

      const query = `
        SELECT v.VisitId, v.VisitDate, v.Diagnosis
        FROM Visits v
        WHERE v.PatientId=${patientId}
        ORDER BY v.VisitDate DESC;
      `;
      let res = db.exec(query);

      if (res.length === 0 || res[0].values.length === 0) {
        container.innerHTML = "<div class='empty'>(Ch∆∞a c√≥ l·∫ßn kh√°m)</div>";
        return;
      }

      let html = "<ul>";
      res[0].values.forEach(row => {
        const vid = row[0];
        const date = row[1].split(".")[0]; // b·ªè mili gi√¢y
        const diagnosis = row[2] || "";
         html += `<li class="visit-item" onclick="showVisitDetail(${vid}, this)">
               üìÖ ${date} ‚Äì ${diagnosis}
             </li>`;
      });
      html += "</ul>";
      container.innerHTML = html;
    }

    // Hi·ªÉn th·ªã chi ti·∫øt l·∫ßn kh√°m
    function showVisitDetail(visitId, el) {
      // reset highlight
  document.querySelectorAll(".visit-item").forEach(li => li.classList.remove("active-visit"));
  if (el) el.classList.add("active-visit");
      const query = `
        SELECT v.VisitDate, v.Diagnosis, v.Symptoms, v.PrescriptionNotes,
               v.MedicationsTotal, v.TotalAmount,
               ef.NameFee, ef.PriceFee,
               m.Name as Medication, m.ActiveIngredient, m.Format,
               vm.Dosage, vm.Quantity, vm.PriceAtDispense,
               u.Instruction
        FROM Visits v
        LEFT JOIN ExaminationFees ef ON v.ExaminationFeeId = ef.ExaminationFeeId
        LEFT JOIN VisitMedications vm ON v.VisitId = vm.VisitId
        LEFT JOIN Medications m ON vm.MedicationId = m.MedicationId
        LEFT JOIN UsageInstructions u ON vm.UsageInstructionId = u.UsageInstructionId
        WHERE v.VisitId=${visitId};
      `;
      let res = db.exec(query);
      if (res.length === 0) {
        document.getElementById("visitDetail").innerHTML = "<p>Kh√¥ng c√≥ d·ªØ li·ªáu</p>";
        return;
      }
      let rows = res[0].values;
      let html = `<h3>L·∫ßn kh√°m ng√†y ${rows[0][0]}</h3>
                  <p><b>Ch·∫©n ƒëo√°n:</b> ${rows[0][1]||""}</p>
                  <p><b>Tri·ªáu ch·ª©ng:</b> ${rows[0][2]||""}</p>
                  <p><b>Ghi ch√∫ ƒë∆°n thu·ªëc:</b> ${rows[0][3]||""}</p>
                  <p><b>Ph√≠ kh√°m:</b> ${rows[0][7]||0}‚Ç´ (${rows[0][6]||""})</p>
                  <p><b>T·ªïng ti·ªÅn thu·ªëc:</b> ${rows[0][4]||0}‚Ç´</p>
                  <p><b>T·ªïng c·ªông:</b> ${rows[0][5]||0}‚Ç´</p>`;
      html += "<h4>ƒê∆°n thu·ªëc</h4><table><tr><th>Thu·ªëc</th><th>Ho·∫°t ch·∫•t</th><th>D·∫°ng</th><th>Li·ªÅu</th><th>S·ªë l∆∞·ª£ng</th><th>Gi√° xu·∫•t</th><th>H∆∞·ªõng d·∫´n</th></tr>";
      rows.forEach(r => {
        html += `<tr>
          <td>${r[8]||""}</td>
          <td>${r[9]||""}</td>
          <td>${r[10]||""}</td>
          <td>${r[11]||""}</td>
          <td>${r[12]||""}</td>
          <td>${r[13]||""}</td>
          <td>${r[14]||""}</td>
        </tr>`;
      });
      html += "</table>";
      document.getElementById("visitDetail").innerHTML = html;
    }

    // T√¨m ki·∫øm b·ªánh nh√¢n
    document.getElementById("searchBox").addEventListener("input", (e) => {
      renderPatients(e.target.value);
    });
  </script>
</body>
</html>